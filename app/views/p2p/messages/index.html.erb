<%#= stylesheet_link_tag "p2p/messages" %>
<%= javascript_include_tag "p2p/messages" %>

<div class="row" id="message_container">

<div id="overlay"></div>


<div id="message_content" class="span12">

		
<div class="tabbable " id="message_side_menu">	
	<div class="row">
		<div class="span2 pull-left" id="message_left_menu">

		  <ul class="nav nav-list">
		    
		 		<!--message modal  -->
		 		<!-- Button to trigger modal -->
					<a href="#compose_newmsg_modal" id="compose_newmsg_button" role="button"  data-toggle="modal" class="btn "  >Compose</a>
					</i>
					 
					<!-- Modal -->
					<div id="compose_newmsg_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="compose_newmsg_modallLabel" aria-hidden="true">
					  <div class="modal-header">
					    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					    <h3 id="compose_newmsg_modalLabel">Send a message to Admin</h3>
					  </div>
					  <div class="modal-body">
					    <p> 			    	
				    	<%= render "p2p/messages/compose" ,:message => @message ,:user_id => current_user.id ,:receiver => nil ,:item => "" %>
						</p>
					  </div>
					</div>


		    <li class="active"><a href="#inbox" data-toggle="tab">
		    	<% unreadcount = @inbox.unread.count %>
		    	Inbox
		    	<span id="inbox_count">
		    		<%= (unreadcount > 0) ?  "(#{unreadcount.to_s})" : "" %>
		    	</span>
		        </a></li>
	            

		    <li><a href="#sent" data-toggle="tab">Sent</a></li>
		    <li><a href="#delete" data-toggle="tab">Trash</a></li>

		  </ul>
		</div>

		<div class="span10" id="box_content">

			<div class="tab-content">
			    
			    <div class="tab-pane active" id="inbox">
			    	<%= render "/p2p/messages/msg_table",:table_name => "inbox" %>
			     </div>
					
				 <div class="tab-pane" id="sent">
			    	<%= render "/p2p/messages/msg_table" ,:table_name => "sentbox" %> 
			      </div>

				 <div class="tab-pane" id="delete">
			    	<%= render "/p2p/messages/msg_table" ,:table_name => "deletebox" %> 
			      </div>

			</div>

			   <div class="span9" id="show_msg">
			   		<button class="btn back_to_table" tbl="">Back</button>
			   		
					<a href="#reply_to_modal" id="reply_to_button" role="button"  data-toggle="modal" class="btn "  >Reply</a>

					<!-- Modal -->
					<div id="reply_to_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="reply_to_modallLabel" aria-hidden="true">
					  <div class="modal-header">
					    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					    <h3 id="reply_to_modalLabel">Reply to <span id="reply_to_user">[user]</span> </h3>
					  </div>
					  <div class="modal-body">
					    <p> 			    	
				    		<%= render "p2p/messages/compose" ,:message => @message  ,:class_name => "reply_to_user" %>
						</p>
					  </div>
					</div>


			   		<div id="show_msg_content"></div>
			   </div> 



		</div>
	</div>
</div>

	<script type="script/template" id="view_msg">

		<%% _.each(data,function(dt){%>

					<hr/>

					<div id="message_user_name" recevid=<%%=dt['receiver']%>> Name:  
						<span id="message_user_name_content">
								<%%= dt['name']%>
						</span>
					</div>

					<div id="message_datetime"> Date:  
						<span id="message_datetime_content">
								<%%= dt['dte'] %>
						</span>
					</div>

					<div id="message_item"> Subject:  
						<span id="message_item_content">
								<%%= dt['sub'] %>
						</span>
					</div>

					<hr>

					<div id="message_message"> Message:  
						<span id="message_message_content">
								<%%= dt['msg'] %>
						</span>
					</div>
		<%% }) %>
	</script>


<div class="hide" id="compose_reply">
		 		<!--message modal  -->
		 		<!-- Button to trigger modal -->

</div>

<script>

	$(document).ready(function(){
		oInboxTable = $('#inbox_table').dataTable({
		  "sDom": "<'row-fluid'<'span6'l><'span6'f>r>t<'row-fluid'<'span6'i><'span6'p>>",
		  'sScrollY':"400px",
          "sAjaxSource": '/p2p/getmessages/inbox' ,
          "aaSorting":[],
          "bScrollCollapse": false,
          "bFilter":false,
       	  "bSort": false,
          "iDisplayLength" : 10,
          "bAutoWidth": false,
          "sPaginationType": "bootstrap",
		  "bProcessing": true,
    	  "bServerSide": true,
		  "fnServerParams": function ( aoData ) {
		  	if ($.trim($("#search_inbox").val()) != ""){
            	aoData.push( { "name" : "searchq" ,"value" : $("#search_inbox").val() } );
            }
          }

		});

		oSentBoxTable  = $('#sentbox_table').dataTable({
		  "sDom": "<'row-fluid'<'span6'l><'span6'f>r>t<'row-fluid'<'span6'i><'span6'p>>",
		  'sScrollY':"400px",
          "aaSorting":[],
          "bScrollCollapse": false,
		  "sAjaxSource": '/p2p/getmessages/sentbox' ,
          "bFilter":false,
       	  "bSort": false,
          "iDisplayLength" : 10,
          "bAutoWidth": false,
          "sPaginationType": "bootstrap",
		  "bProcessing": true,
    	  "bServerSide": true,
		  fnServerParams: function ( aoData ) {
		  	if ($.trim($("#search_sentbox").val()) != ""){
            	aoData.push( { "name" : "searchq" , "value": $("#search_sentbox").val() } );
            }
           }
		});

		oDeleteBoxTable  = $('#deletebox_table').dataTable({
		  "sDom": "<'row-fluid'<'span6'l><'span6'f>r>t<'row-fluid'<'span6'i><'span6'p>>",
		  'sScrollY':"400px",
          "aaSorting":[],
          "bScrollCollapse": false,
		  "sAjaxSource": '/p2p/getmessages/deletebox' ,
          "bFilter":false,
       	  "bSort": false,
          "iDisplayLength" : 10,
          "bAutoWidth": false,
          "sPaginationType": "bootstrap",
		  "bProcessing": true,
    	  "bServerSide": true,
		  fnServerParams: function ( aoData ) {
		  	if ($.trim($("#search_deletebox").val()) != ""){
            	aoData.push( { "name":"searchq","value" :$("#search_deletebox").val() } );
            }
          }
		});


    	$('.master_check').on("click",function(){
    		var tbl=$("#" + $(this).attr("tbl")+ "_id");
    		tbl.children("tbody tr td .msg_check").attr("checked","checked");

    	});

		//set css for the clickable column	
		$('.showmessage').live('click', function () {
			var that = $(this);

			$.ajax({
				url: '/p2p/messages/'	 + that.attr('msgid'),
				type:'get',
				async:false,
				dataType:'json',
				success:function(data){

					var templ = _.template($("#view_msg").html());
					$("#show_msg_content").html(templ({data:data}));

					$('.back_to_table').attr('tbl','inbox');
					//set reply to user and set the msgid to it
					$('.reply_to_user').attr('tbl','inbox');
					$('.reply_to_user').attr('msgid',that.attr('msgid'));

					
					if ($(".back_to_table").attr('tbl') == 'inbox'){
						$("#inbox").fadeOut(100);
					}else if ($(".back_to_table").attr('tbl') == 'sentbox'){
						$("#sentbox").fadeOut(100);
					}
					else if ($(".back_to_table").attr('tbl') == 'deletebox'){
						$("#deletebox").fadeOut(100);
					}


					$("#show_msg").fadeIn(100);
				}
				// },
				// error:function(){
				// 	showNotifications("Something went wrong try again");
				// }
			});
			
			return false;

    	});


		$(".search_messages").keyup(function(){

			if ( $(this).val().length < 3 && $(this).val().length != 0) return false;

			if ($(this).attr('tbl')=='inbox'){
				oInboxTable.fnDraw();
			}
			else if ($(this).attr('tbl')=='sentbox'){
				oSentBoxTable.fnDraw();
			}
			else if ($(this).attr('tbl')=='deletebox'){
				oDeleteBoxTable.fnDraw();
			}

		});

		$('.back_to_table').click(function(){
			$("#show_msg").fadeOut(100);
			if ($(this).attr('tbl') == 'inbox'){
				$("#inbox").css({"display":""});
			}else if ($(this).attr('tbl') == 'sentbox'){
				$("#sentbox").css({"display":""});
			}
			else if ($(this).attr('tbl') == 'deletebox'){
				$("#deletebox").css({"display":""});
			}
		});

		$('#reply_to_button').on('click',function(){

			$("#reply_to_modal .reply_to_user #p2p_message_receiver_id").val($("#show_msg #message_user_name").attr('recevid'));
			$("#reply_to_modal .reply_to_user #p2p_message_parent_id").val($(".reply_to_user").attr('msgid'));
			console.log($("#reply_to_modal"));
			//$("#message_user_name").attr("recev")
		});


		if (window.location.hash != ' '){
			$("#search_inbox").val(window.location.hash);
			$("#search_inbox").trigger('keyup');
		}

	});

</script>

	<div class="clearfix"></div>
</div>

</div>
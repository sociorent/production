
<% content_for :pagetitle  do %>

  <%=@item.title %> listed under <%= @item.product.name %>, <%=@item.category.name %>

<%end %>


<% if p2p_current_user.nil? or (p2p_current_user.id != @item.user.id and !session[:isadmin] ) %>

    <%= render "/p2p/items/preview_item" ,
               :viewimage => @item.get_image(0,:view) ,
               :thumbimage => @item.get_image(0,:thumb) ,
               :fullimage => @item.get_image(0,:view) ,
               :title => @item.title,
               :price => @item.price.to_i.to_s,
               :location => @item.city.name ,
               :ownerid => @item.user_id.to_s,
               :userid => (current_user.nil? ) ? "" : current_user.id.to_s,
               :itemid => @item.id.to_s,
               :solddate => @item.solddate,
               :deletedate => @item.deletedate,
               :viewcount => @item.viewcount.to_s,
               :reqcount => @item.reqCount,
               :description => @item.desc,
               :category => @category_name,
               :subcategory => @sub_category_name,
               :brand => @brand_name,
               :spec => @attr,
               :categoryid => @category_id.to_s,
               :subcategoryid => @sub_category_id.to_s,
               :brandid => @brand_id.to_s,
               :itemspec => @item.product.category.specs,
               :condition => @item.condition,
               :requestmessage => @message,
               :approvedate =>  @item.approveddate,
               :disapproveddate => @item.disapproveddate,
               :paytype => @item.paytype.to_s,
               :payinfo => @item.payinfo
    %>

<% else %>



<%= stylesheet_link_tag "items/items_manifest"%>
                              

<div class="main_wrapper">
     <div class="row">
         <div class="span6">

         	 <!-- breadcumb -->
	          <ul class="breadcrumb">
		           <li>
		           	<a href="/p2p">Home</a> <span class="divider">/</span>
		           </li>
		           <li>
		           	<a href="/p2p/<%=category%>"><%=category.titleize %></a> <span class="divider">/</span>
		           </li>
		           <li>
		           	<a  href="/p2p/<%=category%>/<%=brand%>"><%=brand.titleize %></a> <span class="divider">/</span>
		           </li>
		           <li class="active ">
		           	<%=link_to title.titleize ,{:cat => category ,:prod => brand ,:item => title } %>
		           </li>
	          </ul>
	        </div>

          <div class="span6">

						<div class="btn-group" id="listing_action">

          		<!-- show the sold and not sold button based ont  -->
          		<!-- for admin show the sold and not sold button based on the sold dat -->
	             <% if solddate.nil?  %>
                  <% if !approvedate.nil? %>
	                  <a href="/p2p/sold/<%= itemid %>" class=" btn"   >
	                  	<i class="  action_icon  icon-shopping-cart" title="Mark this listing as sold"></i> Mark as sold
	                  </a>

	                  <!-- if admin display the approve button -->
	                  <%if session[:isadmin]%>
                      <button class="btn alert-info"  id="approve" itemid="<%=itemid%>"><i  class="action_icon icon-thumbs-up" title="Approve this listing"></i></button>
	                  <%end %>

                	<% elsif disapproveddate.nil? %>
	                  <a href="#" class="  btn"  >
	                  	<i class=" action_icon icon-shopping-cart"  title="Listing has not been approved yet"></i>
	                   Waiting for approval
	                  </a>

	                  <% if session[:isadmin]%>
	                    <button class="btn alert-info" id="disapprove"   itemid="<%=itemid%>"><i  class="icon-thumbs-down action-icon" title="DisApprove this listing"></i></button>
	                  <%end %>

                	<% else %>
	                  <a href="#" class="  btn"  >
	                  	<i class=" action_icon icon-ban-circle"  title="Disapproved"></i>
	                  	Disapproved
	                  </a>
             			<% end %>


                  <a href="/p2p/itempayment/<%=itemid%>" class="btn action_popover" data-content="<%=@paytype_content%>" data-html="true" data-trigger="hover" data-dealy="{show:0,hide:500}" data-title="Payment Options" data-placement="bottom" >
                  	<i class="action_icon icon icon-gift" title="<%=@paytype_title%>"></i>
                  	Payment
                  </a>
	             <% end %>
           
              <!-- check if the item is sold or not -->
              <% if deletedate.nil? %>
                <button class="btn  "  id="delete_button"  itemid="<%=itemid%>"><i  class=" action_icon icon-trash" title="Remove Listing"></i></button>
	            <% else %>
	              <button class="btn">
	               	<i  class=" action_icon icon-check" title="Deleted Listing"></i>
	              </button>
              <% end %>

              <button class="btn " id="enable">
              	<i  class="action_icon icon-pencil"  title="Edit Listing"></i>
              </button>

              <button class="btn btn-success hide " id="save"  >
              	<i  class=" action_icon icon-white icon-ok-circle" title="Save changes"></i>
              </button>

              <button class="btn btn-danger hide " id="cancel" >
              	<i  class=" icon-white icon-remove-circle action_icon" title="Cancel changes"></i>
              </button>

              <a href="/p2p/messages/#<%=title%>" role="button" class="btn " data-toggle="modal" ><i  d="reqcount_<%=itemid%>"  class="action_icon icon-envelope" title="View Messages for this listing">  </i>  <%=reqcount if defined?(reqcount) %> </a>

              <button class="btn" id="viewcount" ><i  title="Number of view of this listing" class="action_icon icon-eye-open"></i><%= viewcount %></button>

        </div> <!-- span6 action buttons-->
      </div>
    </div> <!-- row -->


     <div class="row">
        <div class="span4">
          <ul class="thumbnails">
        	  <li class="span4">
	            <div class="thumbnail">
	              <i id="clearuploads" class="icon-trash action_icon pull-right hidden" title="Clear pics uploaded just now" disabled="disabled">
	              </i>
	              <div id="upload_pic" title="Upload more photos" class="action_icon pull-right edit_visible"><i class="icon-upload"></i>Upload</div>

	              <div class="clearfix"></div>

	                <%= form_tag  "/p2p/items", :multipart => true, :id => "fileupload"   do %>
	                  <div id="form_temp"></div>
		                  <%= file_field_tag "img[]" ,:id=> "image_upload" ,:multiple  => 'true' ,:disabled => true  ,:accept => "image/*"  %>
	                <% end %>
			          <div id="view_image_holder">
			            <a href="<%=fullimage[@rand_image][:url]%>" id="view_image_fancy">
			                 <img src="<%= viewimage[@rand_image][:url] %>" imgid="<%= viewimage[@rand_image][:id] %>" alt="Item pic" id="view_image">
			            </a>
			          </div>

			          <div class="caption thumb_holder">
			            <ul class="thumbnails">
			              <% i = 0 %>
			              <% thumbimage.each do |img| %>
				              <li class="thumbs picture_upload_preview">
				                <i class="icon-remove pull-right remove_image hidden"></i>
			                  <img src="<%= img[:url]%>"  imgid="<%= img[:id] %>" alt="" id="image_<%= img[:id]%>" class="thumb_img" fancyimg="<%=fullimage[i][:url]%>" viewimage="<%= viewimage[i][:url] %>">
			                </li>
			              <% i += 1 %>
			            </ul>
			          </div>
	          	</div> <!-- thumbnail div -->
	      		</li>
          </ul>
        </div>

        <div class="span6">
          <center><code class="edit_visible"> All words in <span style="color:blue"> blue</span> are editable.Please click on them to edit</code></center>

          <table class="table table-bordered table-striped" id="table_specs">
            <colgroup>
              <col class="span1">
              <col class="span7">
            </colgroup>
             <thead>
              <tr>
                <th>Specification</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              <tr class="edit_visible">
                <td>Title </td>
                <td>
                	<span class="canEdit action_icon" id="title"  data-original-title="Enter a title for your listing" data-placement="right" data-placeholder="Enter a title" ><%=title.titleize  %></span>
               	</td>
              </tr>
              <tr>
                  <td>Category </td>
                  <td> <span class="canEdit action_icon" id="category_item" data-type="select" data-original-title="Select a category"  data-placement="right" data-placeholder="Select a category"   data-source="/p2p/getcategories" ><%=category%></span></td>
              </tr>
              <tr>
                <td>
                	<%= (!@item.category.nil? and @item.category.name =="Books") ? 'Publisher' : 'Model'%>
                </td>
                <td>
                	<span id="model" class="action_icon "  data-placement="right" data-placeholder="Select a model"  title="Select Model" data-type="select" >
                		<%=brand%>
                	</span>
                  <input type="text" id="add_new_model" placeholder="Other Model" size=10>
                </td>
              </tr>
              <!-- Price -->
              <tr>
                 <td>
                   <span class="highlight">Price</span>
                 </td>
                 <td>
                    <span class="highlight <%= (itemid.empty? ? '' : 'highlight_force_color')%>">
                    	Rs.
                        <span class="canEdit highlight action_icon  <%= (itemid.empty? ? '' : 'highlight_force_color')%>" data-name="username"  title="Enter Price"   data-placement="right" data-placeholder="Enter the price"  specname="price" specid="0" id="price">
                        	<%= price  unless price.nil? %>
                        </span>
                    </span>
                 </td>
              </tr>
            <!-- Location -->
              <tr>
                <td>
                  <span class="highlight"> Condition</span>
                </td>
                <td>
                  <span class="canEdit highlight action_icon  <%= (itemid.empty? ? '' : 'highlight_force_color')%>" data-name="username" data-type="select" data-source="['Brand New','Like New','Used','Old']" title="Enter Condition"  specname="condition" specid="0" id="condition"  data-placement="right" data-placeholder="Select the condition" > <%= condition.titleize %> </span>
                </td>
              </tr>

            <!-- Location -->
              <tr>
                <td>
                  <span class="highlight">Location</span>
                </td>
                <td>
              	  <span class="highlight canEdit action_icon  <%= (itemid.empty? ? '' : 'highlight_force_color')%>" data-name="username"  data-type="typeahead" data-source="/p2p/getcities"  title="Enter Location"  specname="location" specid="0" id="location"  data-placement="right" data-placeholder="Select the Location" >
              	  	<%= location.titleize %>
              	  </span>
                 </td>
              </tr>

              <!-- load some specs hree -->
              <% unless spec.empty? %>
                <% spec_used = [] %>
                <% spec.each do |aspec| %>
                  <% spec_used.push(aspec.spec.id)%>
                    <tr class="specs">
                      <td>
                        <%= aspec.spec.name %>
                      </td>
                      <td>
                        <span class="canEdit action_icon" data-name="username"  title="Enter <%= aspec.spec.name %>"  specname="<%= aspec.spec.name %>" specid="<%= aspec.spec.id.to_s %>" id="item_<%= aspec.spec.id %>" data-placement="right">
                        	<%= aspec.value.titleize  unless aspec.value.nil? %>
                        </span>
                      </td>
                    </tr>
                  <% end %>
              <% end %>

              <!-- keep a check if we have shown all specs here or show more -->
              <%if spec_used.size < spec.size %>
                <tr>
                  <td colspan="2">
                    <a href="#more_details">View more</a>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
     </div><!-- row ends -->


     <div class="row">
          <div id="desc" class="span10">
               <h4> <%= @item.title.titleize %> Description</h4>
               <span id="desc_content" title="Enter Description(More than 20 letters)" data-type="wysihtml5" class="canEdit action_icon" inputclass="desc_content_form" data-wysihtml5="{image:false}"> <%= @item.desc.html_safe %> </span>
          </div>
     </div>

     <!-- if we have more specs -->
		<% unless spec.empty? and spec_used.size < spec.size %>

        <div class="row">
          <div class="span12" id="more_details">
            <table class="table table-bordered table-striped">
              <colgroup>
                <col class="span1">
                <col class="span7">
              </colgroup>
            <thead>
              <tr>
            	  <th>Specification</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
           <!-- load remaining spec -->
              <% (spec_used..((spec.size)-1)).each do |i| %>
                <tr>
                  <td> <%= spec[i].spec.name %> </td>
                  <td>
                    <span class="canEdit" data-name="username"  title="<%=spec[i].name%>"  specname="<%= spec[i].spec.name %>" specid="<%= spec[i].spec.id.to_s %>" id="item_<%= spec[i].spec.id %>" data-placement="right">
                    	<%= spec[i].value.titleize %>
                    </span>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>
 
 		<!-- if we have more specs that are not yet used -->
    <% if itemspec.count > spec_used.count %>
      <div id="add_more_spec" class="hide">
        <b>Add More Specification here <br/></b>
        <table class="table table-bordered table-striped hide" id="empty_specs">
          <tr>
            <th>Specification</th>
            <th>Value</th>
          </tr>
          <% itemspec.each do |spec| %>
          	<!-- skipe if we have already loaded this spec -->
            <% next if !spec_used.nil?  and spec_used.include?(spec.id) %>
              <tr>
                <td><%= spec.name %> </td>
                <td>
                  <span class="canEdit" data-name="<%=spec.name%>"  title="Enter <%=spec.name%>"  specname="<%= spec.name %>" specid="<%= spec.id.to_s %>" id="item_<%= spec.id %>" data-placement="right">  </span>
                </td>
              </tr>
           <% end %>
          </table>
      </div>
    <%end %>


<script>


     window.item_id = '<%= @item.id%>';
     <% if !current_user.nil? and (ownerid == p2p_current_user.id.to_s) %>

          window.editsaveurl = '<%= (itemid.empty?) ? "/p2p/items": "/p2p/items/" + itemid %>';
          window.editsavetype = '<%= (itemid.empty?) ? "post": "put"%>';

          $("#image_upload").val("");
          //initialize

          window.image_count =  <%= (itemid.empty?) ? 0 : viewimage.count %>;

          window.item_values ={};
          item_values['spec']={};
          window.edit = <%= (itemid.empty?) ? false : true %>;

                    <%if !itemid.empty?  and ownerid == p2p_current_user.id.to_s %>
                         item_values['title'] = "<%= title %>";
                         item_values['cat'] = "<%= categoryid %>";
                         item_values['scat'] = "<%= subcategoryid %>";
                         item_values['brand'] = "<%= brandid %>";
                         item_values['price'] = "<%= price %>";
                         item_values['condition'] = "<%= condition %>";
                         item_values['desc'] = $("#desc_content").html();
                         item_values['location'] = "<%=location%>";

                         <% spec.each do |aspec| %>
                              item_values['spec']['<%= aspec.spec.id%>'] = "<%= aspec.value %>";
                         <% end %>


                    <% end %>

     <% end %>

     <% if itemid.empty? %>
          $(document).ready(function(){



               $('#enable').trigger("click");
               console.log('clicked');


          });

     <% end %>



// <#% if !p2p_current_user.nil? and p2p_current_user.mobileverified == 0 %>

$(document).ready(function(){



          $("#send_verify_code").click(function(){
               $(this).html('Sending verification code').attr('disabled','disabled');

               $.ajax({
                    url:'/p2p/users/verifymobile/code',
                    type:'post',
                    dataType:'json',
                    success:function(data){
                         if (data.status== 1){
                              $("#send_verify_code").removeClass('btn-primary').attr('disabled','disable').html('Code Sent');

                              $("#verify_code_submit").addClass('btn-primary');

                         }else{
                              showNotifications('Some error occured. Try again.');
                              $("#send_verify_code").addClass('btn-primary').removeAttr('disabled').html('Failed.Retry');
                         }
                    },
                    error:function(){
                              showNotifications('Some error occured. Try again.');
                              $("#send_verify_code").addClass('btn-primary').removeAttr('disabled').html('Failed.Retry');

                    }

               });//ajax
          });//click


          $("#verify_code_submit").click(function(){


               if ($("#verify_mobile").val().length  <4){
                    alert('Wrong code. Enter the correct code');
                    return false;
               }

               $(this).html('Verifying code').attr('disabled','disabled');

               $.ajax({
                    url:'/p2p/users/verifymobile/' + $("#verify_mobile").val(),
                    type:'post',
                    dataType:'json',
                    success:function(data){
                         if (data.status== 1){
                              $("#mobile_verify_modal").modal('hide');
                              $("#mobile_verify_modal_button").remove();
                              $("#contact_seller_modal_button").removeClass('hide');
                              alert('Sucessfully Verified');
                              $("#contact_seller_modal_button").trigger('click');

                         }else{
                              showNotifications('Some error occured. Try again.');
                              $("#verify_code_submit").addClass('btn-primary').removeAttr('disabled').html('Failed.Retry');
                         }
                    },
                    error:function(){
                              showNotifications('Some error occured. Try again.');
                              $("#verify_code_submit").addClass('btn-primary').removeAttr('disabled').html('Failed.Retry');

                    }

               });//ajax
          });

     });

// <#% end %>


</script>



<% end %>
<%= stylesheet_link_tag "p2p/items" %>
<%= javascript_include_tag "p2p/jquery.jeditable.mini" %>
<%= javascript_include_tag "global/jquery.ui.accordion" %>

<div class="container">

<div id="item_left_container" class="pull-left span2">

	<span class="point_left left_element">
		<img src="<%= thumbimage[0][:url] %>" imgid="<%= thumbimage[0][:id] %>" alt="" id="left_thumb_image" ></img>
		<div class="clearfix"></div>
	</span>

	<span class="left_element left_element_hover" id="left_item_category"> 
		<span class="arrow">></span>
		<%= category %>
	</span>		


	<span class="left_element" id="left_item_spec"> 

			<% unless spec.empty? %>

				<% unless itemid.empty? %>
					Specifications:
							
						<table class="table table-striped table-bordered">
							<% spec.each do |aspec| %>
							<tr width="100%">
								<td class="item_label"> <%= aspec.spec.name %> </td>
								<td class="specification"  specname="<%= aspec.spec.name %>" specid="<%= aspec.spec.id.to_s %>" id="item_<%= aspec.spec.id %>"> <%= aspec.value %> </td>
							</tr>
							<% end %>
						</table>				
				<% end %>
			<% end %>

	</span>

	
</div>

<div id="item" class="pull-left span10">

	<div id="item_title" class="editable"> <%= title %> </div> 	
	
	<% if userid == ownerid  and !itemid.empty? %>
		<div class="pull-right btn btn-info" id="edit_item">Edit Item</div>
	<% end %>

	<div id="edit_actions">

		<a href="javascript:history.back();" class="btn btn-danger pull-right span1" id="cancel_edit">
			<span id="cancel_edit_btn" ></span> Cancel </a>

		<div class="btn btn-success pull-right span1"  id="finish_edit">
			<span id="finish_edit_btn" ></span> Save
		</div>
	
		<code class="pull-right">All elements in <span style="color:blue">blue</span> are editable</code>
	</div>

	<div id="item_image_holder" class="pull-left">

		<div id="item_image">

				<span style="min-height:250px;">
					<img src="<%= viewimage[0][:url] %>" imgid="<%= viewimage[0][:id] %>" alt="" id="view_image" ></img>
				</span>
				<% if !itemid.empty?  and userid == ownerid %>



						<span class="pull-left" id="add_image">
							<span id="image_upload_form"></span> Add Image</span>			
						<%= form_tag "/p2p/addimage" ,:multipart => true , :id => "add_image_form" do %>
								<input type="hidden" value="<%= @item.id %>" name="item_id">
				                <input type="file" name="img[]" multiple id="file_add_image" disabled="disabled">
							<% end %>
							<span id="remove_image"><img src="/assets/Trash-can-icon.png"> </span>													
						</span>


				<% else %>
					<span class="pull-left edit_hidden" id="add_image_info">
						<code> You can add image after you save your item </code>
					</span>
				<%end %>
				<div class="clearfix"></div>
		</div>

		<div class="thumbnail">
			<% i = 0 %>
			<% thumbimage.each do |img| %>
				<span class="thumb_img_holder">
					<img src="<%= img[:url]%>" imgid="<%= img[:id] %>" alt="" id="image_<%= img[:id]%>" class="thumb_img" viewimage="<%= viewimage[i][:url] %>"> </img>
				</span>
				<% i = i + 1 %>
			<% end %>
			<div class="clearfix"></div>
		</div>

		<div class="clearfix"></div>
	</div>

	<div id="item_details" class="span6 pull-left">
		<div id="item_classification">

			<span  class="pull-left" >
				<span class=" item_label"> Category: </span>
				<span class="label label-warning" catid="" id="item_category"> <%= category %></span>
			</span>

			<span class="pull-left">
				<span class=" item_label"> Sub-Category: </span>
				<span  class="label label-ok" scatid="" id="item_sub_category" > <%= subcategory%> </span>
			</span>

			<span class="pull-left">
				<span class=" item_label"> Brand: </span>
				<span  class="label label-info"  bid="" id="item_brand" > <%= brand %></span>
			</span>

		<div class="clearfix"></div>
		</div>

		<div id="item_price"> 
			<span class=" item_label">Price:<del>&#2352;</del> </span>
			<span id="item_price_content"><%=price%> </span>
		</div>

		<div id="item_location" class="pull-right">
			<span class=" item_label"> Location: </span> <br/>
			<span id="item_location_content"><%= location %> </span>
		</div>


	<% if userid.empty? or (ownerid != userid) %>

		<div id="item_action_buttons">
			<!-- seller info -->


			<div id="buy_now_accordion">
			  <h3 id="accordion_head">Buy via Sociorent</h3>
			  <div>
			    <p>
			    	<a class="btn btn-primary">Pay Now</a>
			    </p>
			  </div>

			  <h3>Buy Directly</h3>
				  <div>

					<a href="#contact_seller_modal" role="button" class="btn btn-info pull-left" data-toggle="modal" id="contact_seller_button">Contact Seller</a>

					<!-- Modal -->
					<div id="contact_seller_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="contact_seller_modalLabel" aria-hidden="true">
					<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					<h3 id="contact_seller_modalLabel">Send a Buy Request</h3>
					</div>
					<div class="modal-body">

						<p>
							<% if !userid.empty? %>
									 <%= render "p2p/messages/compose" ,
									 			:message => P2p::Message.new ,
									 			:user_id => userid ,
									 			:receiver => ownerid ,
									 			:item => itemid
									 %>
							<% else %>
									Login to Send Buy Request
							<% end %>
						</p>

					</div>
					</div>


			  </div>

			</div>

			<div class="clearfix"></div>

		</div>

	<% else %>

		<div id="item_analytics">
			<% if !(itemid.empty?) %>

				<% if solddate.nil? %>
					<a href="/p2p/sold/<%= itemid %>" class="btn btn-success">Mark as Sold!</a>
				<% else %>
					<span class="btn btn-info">Item Sold on <%= solddate.strftime("%d-%b-%C%y") %> </span>
				<%end %>
			


			<% if deletedate.nil? %>
				<a href="/p2p/delete/<%= itemid %>" class="btn btn-danger" id="item_delete_button"> Delete </a>
			<% else %>
				<span class="btn btn-info">Item Sold on <%= @item.solddate.strftime("%d-%b-%C%y") %> </span>
			<%end %>
		<% end %>				

			<span class=" item_label"><h4> Analytics </h4></span>
			<div id="view_count"> 
    
    			<span class=" item_label">View Count: </span><br/>
    				<span class="progress ">
    					<span class="bar  bar-warning" style="width:100%;">
    						<span class="badge"> <%= viewcount %> </span>
    					</span>
    				</span>
    
			</div>

			<div id="view_req_count"> 	
    
    			<span class=" item_label">Request Count: </span><br/>
    				<span class="progress  ">
    					<span class="bar bar-success" style="width:<%= reqcount %>%;">
    							<span class="badge"> 	 <%= reqcount %>  </span>
    					</span>
    				</span>
    
			</div>
			
		</div>

	<% end %>

	<div class="clearfix"></div>

	</div>

	<div id="item_desc" class="span9">
		<span class="span9 item_label"> Description:  </span>
		<span class="span9" id="item_desc_content"> <%= description %> </span>
	</div>

	<br/><br/>
	<div id="item_spec" class="span9">
		<span class="span9  item_label"> Specification for <%= title %>:  </span>

		<span class="span6" id="item_spec_content"> 

			<% if spec.empty? %>
				Choose Category to load Specification 
			<% else %>

				<% if itemid.empty? %>
					<%= render "/p2p/items/editspec" ,:spec => spec  %>
				<% else %>
					<%= render "/p2p/items/editspec" ,:spec => spec ,:itemspec => itemspec %>
				<% end %>
			<% end %>

		</span>
	</div>

	<div class="clearfix"></div>
</div>

			<button href="#initialize_modal" class="hidden" data-toggle="modal"  id="initialize_button">Contact Seller</button>
			<!-- Modal -->
			<div id="initialize_modal" class="modal show fade" tabindex="-1" role="dialog" aria-labelledby="initialize_modalLabel"  data-keyboard="false" aria-hidden="true">
				<div class="modal-header">
					<button type="button" class="close hidden" data-dismiss="modal" aria-hidden="true">×</button>
					<h3 id="initialize_modalLabel">List your Item</h3>
				</div>

				<div class="modal-body">

				<p>

					<div id="item_classification_modal" class=" form-horizontal">

						<h4>Item Category</h4>

					  <div class="content">
						<div class="control-group">
							<%= label_tag "Category" ,"Category",:class=>"control-label" %>
							<div class="controls">
								<%= select_tag "item[category]" ,options_from_collection_for_select(P2p::Category.all,"id","name") ,:prompt => "Select a Category" ,:id => "item_category1" ,:class => "required" %>
							</div>
						</div>


						<div class="control-group">
							<%= label_tag "SubCategory" ,"Sub Category",:class=>"control-label" %>
							<div class="controls">
								<%= select_tag "item[category]" ,options_from_collection_for_select([],0,0),:prompt => "Select a sub Category" ,:id=> "item_sub_category1" %>
							</div>
						</div>

						<div class="control-group">
							<%= label_tag "Brand" ,"Brand",:class=>"control-label" %>
							<div class="controls">
								<%= select_tag "item[brand]" ,options_from_collection_for_select([],0,0),:prompt => "Select a Brand" ,:id=> "item_brand1" ,:class => "required" %>
							</div>
						</div>
					  </div>
					</div>

				</p>

				</div>

				  <div class="modal-footer">
				  	<% if itemid.empty? %>
    					<a href="javascript:history.back();" class="btn">Cancel</a>
    				<% else %>
    					<a href="javascript:$('#initialize_modal .close').trigger('close')" class="btn">Cancel</a>
    				<% end %>

    				<a href="javascript:validateform()" class="btn btn-primary">Save changes</a>
  				  </div>

			</div>





<script>


	var url ="";


<% if (userid == ownerid  and !itemid.empty?) || itemid.empty? %>

	var validateform = function(){

		$("#item_category1").removeClass("error");
		$("#item_brand1").removeClass("error");

		if ( $("#item_category1").val() == ""){
			$("#item_category1").addClass("error")
			return false;
		}else if ( $("#item_brand1").val() == ""){
			$("#item_brand1").addClass("error")
			return false;
		}

		item_values["cat"] = $("#item_category1 :selected").val();
		item_values["brand"] = $("#item_brand1 :selected").val();
		item_values["scat"] = "";

		$("#left_item_category").html("<a href='/p2p/'" + $("#item_category1 :selected").text() + ">" + $("#item_category1 :selected").text() + "</a>");

		$("#item_category").html($("#item_category1 :selected").text());
		$("#item_brand").html($("#item_brand1 :selected").text());
		$("#item_sub_category").html($("#item_sub_category1 :selected").text());

		if ($("#item_sub_category1").val() != 0){
			$("#item_sub_category").attr("scatid",$("#item_sub_category1 :selected").val());		
			item_values["scat"] = $("#item_sub_category1 :selected").val();
		}

		$("#item_category").attr("catid",$("#item_category1 :selected").val());
		$("#item_brand").attr("bid",$("#item_brand1 :selected").val());

		console.log(item_values);
		$("#initialize_modal .close").trigger("click");
	}




function edititem(){
			window.item_values ={};
			item_values['spec']={};

			<%if !itemid.empty?  and ownerid == userid %>
				item_values['title'] = "<%= title %>";
				item_values['cat'] = "<%= categoryid %>";
				item_values['scat'] = "<%= subcategoryid %>";
				item_values['brand'] = "<%= brandid %>";
				item_values['price'] = "<%= price %>";
				item_values['desc'] = $("#item_desc_content").html();

				<% spec.each do |aspec| %>
					item_values['spec']['<%= aspec.spec.id%>'] = "<%= aspec.value %>";
				<% end %>

			<% end %>

	$("#remove_image").click(function(){
		$.ajax({
			url:"/p2p/images/" + $("#view_image").attr("imgid"),
			type:"delete",
			dataType:"json",
			data:{"authenticity_token" : AUTH_TOKEN},
			success:function(data){
				if (data.status == 1){
					var imgid = $("#view_image").attr("imgid");

					$("#image_" + imgid).parent().remove();
					$(".thumb_img").trigger("click");
				}
			}
		});
	});


		var replaceText = function(val){ return val;}

		function editElem(elem,callback,type){
			
			if (typeof(type) === undefined) type = "text";

			$(elem).editable(callback,
				{
				indicator:"Saving..! Please wait",
				tooltip: "click to edit",
				cssclass:"inlineinput",
				type:type,
				onblur:"submit",
				width:"auto",
				height:"auto",
				autocomplete:"on"
				}
			);
		}

		var validate_length = function(key,name,len) {
			return function(val){ 

				regexp = new RegExp("\.{" + len + ",}");
				if (val.match(regexp )) {
					item_values[key] = val;
					console.log(item_values);
					return val;
				}
				else{
					alert(name + " must be more than " + len + " letters");
					return this.revert;
				}
			};
		}

		var validate_spec = function(key,name,len) {
			return function(val){ 
				if (val.length !=0){
					regexp = new RegExp("\\w{" + len + ",}");
					if (val.match(regexp )) {
						item_values['spec'][key] = val;
						console.log(item_values);
						return val;
					}
					else{
						item_values['spec'][key] = "";
						alert(name + " must be more than " + len + " letters");
						return this.revert;
					}
				}
				else{
						item_values['spec'][key] = "";
						return "";
				}
			};
		}

		var validate_price = function(key){
			return function(val){
				$("#item_price").removeClass("error");
				val=$.trim(val);
				if (val.match(/^\d*$/) != null) {
					item_values[key] = val;
					return val;
				}
				else{
					$("#item_price").addClass("error");
					alert("Enter amount in Positive number");
					return this.revert ;
				}
			}
		}


		var validate_title = validate_length("title","Title ",5);
		var validate_desc = validate_length("desc","Description " ,20);


		editElem("#item_title",validate_title);
		editElem("#item_price_content",validate_price("price"));
		editElem("#item_location_content",replaceText("location"));
		editElem("#item_desc_content",validate_desc,"textarea");

		$("#file_add_image").change(function(){
					$("#add_image_form").submit();
			});



		//modal initialze


				cat_fetch_error = function(){
							$("#itemattributes").html('<div class="control-group"><div class="controls info-warning">Select category to show deatils </div></div>');	
						}

				cat_change =function(elem){

					if ($(this).val()==""){
						cat_fetch_error();
						return false;
					}
					$.ajax({
						url:'/p2p/getattributes/' + $("this").val(),
						type:"get",
						success:function(data){
								$("#item_spec_content").html(data);

						},
						error:cat_fetch_error()

					});
				}

			$("#item_category1").change(function(elem){


					var that =$("#item_sub_category1")


					if ($(this).val()==""){
						cat_fetch_error();
						return false;
					}


					$.ajax({
						url:'/p2p/getsubcategories/' + $(this).val(),
						type:"get",
						dataType:"json",
						success:function(data){
		    					that.empty();
		    						that.append('<option value="">Select a Sub Category </option>');
		    					
		    					_.each(data,function(option){
		      						that.append('<option value="' + option.id + '">' + option.name + '</option>');
		    					

		    					});
						}

					});

					load_attr_brand($(this).val());

				});

			function spec_edit(){
				var elem = $("#item_specifications td[id^=item_]");

				for (var i=0 ;i<elem.length;i++){
					$(elem[i]).css("color","blue");
					editElem($(elem[i]),validate_spec($(elem[i]).attr("specid"),$(elem[i]).attr("specname"),3));

				}

			}
			function load_attr_brand(val){

					$.ajax({
						url:'/p2p/getattributes/' + val,
						type:"get",
						success:function(data){
								$("#item_spec_content").html(data);

								item_values["spec"] = {};
								spec_edit();

						},

						error:cat_fetch_error()

					});

					that = $("#item_brand1");

					$.ajax({
						url:'/p2p/getbrand/' + val,
						type:"get",
						success:function(data){
		    					that.empty();
		    						that.append('<option value="">Select a Brand </option>');
		    						
		    					_.each(data,function(option){
		      						that.append('<option value="' + option.id + '">' + option.name + '</option>');
		    					

		    					})
		    				},
						error:cat_fetch_error()

					});


			}
			$("#item_sub_category1").change(function(elem){

					if ($(this).val()==""){
						cat_fetch_error();
						return false;
					}

					load_attr_brand($(this).val());

				});

			$("#item_classification span span").click(function(){$("#initialize_button").trigger("click");});

			<% if itemid.empty? %>
				$("#initialize_button").trigger("click");
			<% end %>

			$("#finish_edit").click(function(){

				$("#item_category").removeClass("error");

				$("#item_brand").removeClass("error");
				$("#item_desc").removeClass("error");
				$("#item_title").removeClass("error");
				$("#item_price").removeClass("error");
				$("#item_specifications").removeClass("error");

				if (!('cat' in item_values) || item_values['cat'] == "") {
					$("#item_category").addClass("error");
					alert("Select a category");
					return false;
				}

				if (!('brand' in item_values) || item_values['cat'] == "") {
					$("#item_brand").addClass("error");
					alert("Select a Brand");
					return false;
				}

				if (!('title' in item_values) || item_values['title'] == ""){
					$("#item_title").addClass("error");
					alert("Enter item title");
					return false;
				}

				if (!('price' in item_values) || item_values['price'] == ""){
					$("#item_price").addClass("error");
					alert("Enter item price");
					return false;
				}

				if (!('desc' in item_values) || item_values['desc'] == ""){
					$("#item_desc").addClass("error");
					alert("Enter item description");
					return false;
				}


				if (_.size(item_values['spec']) == 0){
					$("#item_specifications").addClass("error");
					alert("Enter Specifications");
					return false;
				}
					var flag = 1;

				_.each(item_values['spec'],function(value,key){
					$("#item_" + key).removeClass("error");
					if (value == ""){
						$("#item_" + key).addClass("error");
					}else{
						flag =  0;
					}
				});

				if (flag){
					alert(" Enter Specifications" );
					return false;
				}


				item_values['authenticity_token']= AUTH_TOKEN;
				$.ajax({
					url:'<%= (itemid.empty?) ? "/p2p/items": "/p2p/items/" + itemid %>',
					data:item_values,
					type:'<%= (itemid.empty?) ? "post": "put"%>',
					success:function(data){
						if (data['status'] == 1){
							window.location.href = "/p2p/" + data['id']
						}
						else{
							alert(data['status']);
						}
					}
				});

			});

			function edithighlight(){
				var color ="blue"
				$("#item_category").css("color",color);
				$("#item_sub_category").css("color",color);
				$("#item_brand").css("color",color);
				$("#item_desc_content").css("color",color);
				$("#item_title").css("color",color);
				$("#item_price_content").css("color",color);
				$("#item_specifications td[id^=item_]").css("color",color);
			}

			edithighlight();
			spec_edit();

			$("#edit_actions").css({"display":"block"});
			$("#finish_edit").css({"display":"block"});
			$("#cancel_edit").css({"display":"block"});
			$("#add_image").css({"display":"block"});
			$("#file_add_image").removeAttr("disabled");
			$("#remove_image").css({"display":"inline-block"});

}
<% end %>

	<% if itemid.empty? %>
		edititem();		//call if u need to edit

	<% else %>
		$("#edit_item").click(function(){
			edititem();
			$(".edit_hidden_spec").css({"display":"table-row"});
			$(".edit_hidden").css({"display":"block"});
			
			$(this).hide();
		});
	<% end %>

$(".thumb_img_holder").click(function(){
	$("#view_image").attr("src",$(this).children("img").attr("viewimage"));
	$("#view_image").attr("imgid",$(this).children("img").attr("imgid"));
});



//for accordion
 	$("#buy_now_accordion").accordion({
		active :3,
		event:"click hoverintent"
	});

</script>

</div>